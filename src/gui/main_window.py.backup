"""
Finestra principale applicazione
Calcolatore Cerchiature NTC 2018
"""

from PyQt5.QtWidgets import *
from PyQt5.QtCore import *
from PyQt5.QtGui import *
import os
import json

# Import dei moduli
try:
    from src.gui.modules.input_module import InputModule
except ImportError:
    print("Warning: InputModule non trovato")
    InputModule = None

try:
    from src.gui.modules.openings_module import OpeningsModule  
except ImportError:
    print("Warning: OpeningsModule non trovato")
    OpeningsModule = None

try:
    from src.gui.modules.calc_module import CalcModule
except ImportError:
    print("Warning: CalcModule non trovato")
    CalcModule = None

# Modulo ancora da implementare
ReportModule = None

class MainWindow(QMainWindow):
    """Finestra principale con gestione moduli"""
    
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Calcolatore Cerchiature NTC 2018 - Arch. M. Bartolotta")
        self.setGeometry(100, 100, 1200, 800)
        
        # Centra la finestra
        self.center_window()
        
        # Dati progetto condivisi tra moduli
        self.project_data = {}
        self.current_file = None
        self.is_modified = False
        
        self.setup_ui()
        self.setup_menu()
        self.setup_toolbar()
        self.setup_statusbar()
        
    def center_window(self):
        """Centra la finestra sullo schermo"""
        screen = QApplication.desktop().screenGeometry()
        size = self.geometry()
        self.move(
            (screen.width() - size.width()) // 2,
            (screen.height() - size.height()) // 2
        )
        
    def setup_ui(self):
        """Configura interfaccia con tabs"""
        # Widget centrale con tab
        self.tabs = QTabWidget()
        self.tabs.setTabPosition(QTabWidget.North)
        self.setCentralWidget(self.tabs)
        
        # Stile per i tab
        self.tabs.setStyleSheet("""
            QTabWidget::pane {
                border: 1px solid #ccc;
                background: white;
            }
            QTabBar::tab {
                padding: 8px 16px;
                margin-right: 4px;
            }
            QTabBar::tab:selected {
                background: #3498db;
                color: white;
                font-weight: bold;
            }
        """)
        
        # Modulo input struttura
        if InputModule:
            self.input_module = InputModule()
            self.input_module.data_changed.connect(self.on_data_changed)
            self.tabs.addTab(self.input_module, "üìê Struttura")
        else:
            self.tabs.addTab(QLabel("Errore caricamento modulo"), "Struttura")
        
        # Modulo aperture
        if OpeningsModule:
            self.openings_module = OpeningsModule()
            self.openings_module.data_changed.connect(self.on_data_changed)
            self.tabs.addTab(self.openings_module, "üîß Aperture")
        else:
            # Placeholder se modulo non disponibile
            openings_placeholder = QWidget()
            openings_layout = QVBoxLayout()
            openings_label = QLabel(
                "<h2>Modulo Aperture e Rinforzi</h2>"
                "<p>Errore nel caricamento del modulo.</p>"
            )
            openings_label.setWordWrap(True)
            openings_label.setMargin(20)
            openings_layout.addWidget(openings_label)
            openings_layout.addStretch()
            openings_placeholder.setLayout(openings_layout)
            self.tabs.addTab(openings_placeholder, "üîß Aperture")
        
        # Modulo calcolo
        if CalcModule:
            self.calc_module = CalcModule()
            self.calc_module.calculation_done.connect(self.on_calculation_done)
            self.tabs.addTab(self.calc_module, "üßÆ Calcolo")
        else:
            calc_placeholder = QWidget()
            calc_layout = QVBoxLayout()
            calc_label = QLabel(
                "<h2>Modulo Calcolo e Verifica</h2>"
                "<p>Errore nel caricamento del modulo.</p>"
            )
            calc_label.setWordWrap(True)
            calc_label.setMargin(20)
            calc_layout.addWidget(calc_label)
            calc_layout.addStretch()
            calc_placeholder.setLayout(calc_layout)
            self.tabs.addTab(calc_placeholder, "üßÆ Calcolo")
        
        # Modulo relazione
        report_placeholder = QWidget()
        report_layout = QVBoxLayout()
        report_label = QLabel(
            "<h2>Modulo Generazione Relazione</h2>"
            "<p>In questo modulo sar√† possibile:</p>"
            "<ul>"
            "<li>Generare relazione di calcolo in PDF</li>"
            "<li>Esportare tabulati e grafici</li>"
            "<li>Personalizzare intestazione</li>"
            "<li>Includere allegati fotografici</li>"
            "</ul>"
            "<p><i>üöß Modulo in sviluppo...</i></p>"
        )
        report_label.setWordWrap(True)
        report_label.setMargin(20)
        report_layout.addWidget(report_label)
        report_layout.addStretch()
        report_placeholder.setLayout(report_layout)
        self.tabs.addTab(report_placeholder, "üìÑ Relazione")
        
        # Connetti il cambio tab
        self.tabs.currentChanged.connect(self.on_tab_changed)
        
        # Sincronizza dati tra moduli
        self.sync_modules_data()
        
    def sync_modules_data(self):
        """Sincronizza i dati tra i moduli"""
        # Quando cambiano i dati nel modulo input, aggiorna modulo aperture
        if hasattr(self, 'input_module') and hasattr(self, 'openings_module'):
            # Passa dati iniziali del muro al modulo aperture
            wall_data = self.input_module.collect_data().get('wall')
            if wall_data:
                self.openings_module.set_wall_data(wall_data)
                
            # Passa aperture esistenti
            openings = self.input_module.collect_data().get('openings', [])
            self.openings_module.set_openings(openings)
            
    def setup_menu(self):
        """Configura menu applicazione"""
        menubar = self.menuBar()
        
        # Menu File
        file_menu = menubar.addMenu('&File')
        
        new_action = QAction(QIcon.fromTheme('document-new'), '&Nuovo Progetto', self)
        new_action.setShortcut('Ctrl+N')
        new_action.setStatusTip('Crea un nuovo progetto')
        new_action.triggered.connect(self.new_project)
        file_menu.addAction(new_action)
        
        open_action = QAction(QIcon.fromTheme('document-open'), '&Apri Progetto...', self)
        open_action.setShortcut('Ctrl+O')
        open_action.setStatusTip('Apri un progetto esistente')
        open_action.triggered.connect(self.open_project)
        file_menu.addAction(open_action)
        
        save_action = QAction(QIcon.fromTheme('document-save'), '&Salva Progetto', self)
        save_action.setShortcut('Ctrl+S')
        save_action.setStatusTip('Salva il progetto corrente')
        save_action.triggered.connect(self.save_project)
        file_menu.addAction(save_action)
        
        save_as_action = QAction(QIcon.fromTheme('document-save-as'), 'Salva con &nome...', self)
        save_as_action.setShortcut('Ctrl+Shift+S')
        save_as_action.setStatusTip('Salva il progetto con un nuovo nome')
        save_as_action.triggered.connect(self.save_project_as)
        file_menu.addAction(save_as_action)
        
        file_menu.addSeparator()
        
        # Menu progetti recenti
        self.recent_menu = file_menu.addMenu('Progetti &recenti')
        self.update_recent_menu()
        
        file_menu.addSeparator()
        
        export_menu = file_menu.addMenu('&Esporta')
        
        export_excel = QAction('Esporta in Excel...', self)
        export_excel.setStatusTip('Esporta dati in formato Excel')
        export_menu.addAction(export_excel)
        
        export_dxf = QAction('Esporta geometria DXF...', self)
        export_dxf.setStatusTip('Esporta geometria in formato DXF')
        export_menu.addAction(export_dxf)
        
        file_menu.addSeparator()
        
        exit_action = QAction(QIcon.fromTheme('application-exit'), '&Esci', self)
        exit_action.setShortcut('Ctrl+Q')
        exit_action.setStatusTip('Esci dall\'applicazione')
        exit_action.triggered.connect(self.close)
        file_menu.addAction(exit_action)
        
        # Menu Modifica
        edit_menu = menubar.addMenu('&Modifica')
        
        undo_action = QAction(QIcon.fromTheme('edit-undo'), '&Annulla', self)
        undo_action.setShortcut('Ctrl+Z')
        undo_action.setEnabled(False)
        edit_menu.addAction(undo_action)
        
        redo_action = QAction(QIcon.fromTheme('edit-redo'), '&Ripeti', self)
        redo_action.setShortcut('Ctrl+Y')
        redo_action.setEnabled(False)
        edit_menu.addAction(redo_action)
        
        edit_menu.addSeparator()
        
        copy_action = QAction(QIcon.fromTheme('edit-copy'), '&Copia', self)
        copy_action.setShortcut('Ctrl+C')
        copy_action.setEnabled(False)
        edit_menu.addAction(copy_action)
        
        paste_action = QAction(QIcon.fromTheme('edit-paste'), '&Incolla', self)
        paste_action.setShortcut('Ctrl+V')
        paste_action.setEnabled(False)
        edit_menu.addAction(paste_action)
        
        # Menu Visualizza
        view_menu = menubar.addMenu('&Visualizza')
        
        zoom_in_action = QAction('Zoom &avanti', self)
        zoom_in_action.setShortcut('Ctrl++')
        view_menu.addAction(zoom_in_action)
        
        zoom_out_action = QAction('Zoom &indietro', self)
        zoom_out_action.setShortcut('Ctrl+-')
        view_menu.addAction(zoom_out_action)
        
        zoom_fit_action = QAction('&Adatta alla finestra', self)
        zoom_fit_action.setShortcut('Ctrl+0')
        view_menu.addAction(zoom_fit_action)
        
        # Menu Strumenti
        tools_menu = menubar.addMenu('&Strumenti')
        
        materials_action = QAction('&Database Materiali...', self)
        materials_action.setStatusTip('Gestisci database materiali')
        materials_action.triggered.connect(self.show_materials_dialog)
        tools_menu.addAction(materials_action)
        
        profiles_action = QAction('Database &Profili...', self)
        profiles_action.setStatusTip('Gestisci database profili metallici')
        profiles_action.triggered.connect(self.show_profiles_dialog)
        tools_menu.addAction(profiles_action)
        
        tools_menu.addSeparator()
        
        settings_action = QAction('&Impostazioni...', self)
        settings_action.setStatusTip('Configura impostazioni applicazione')
        settings_action.triggered.connect(self.show_settings_dialog)
        tools_menu.addAction(settings_action)
        
        # Menu Aiuto
        help_menu = menubar.addMenu('&Aiuto')
        
        manual_action = QAction(QIcon.fromTheme('help-contents'), '&Manuale Utente', self)
        manual_action.setShortcut('F1')
        manual_action.setStatusTip('Apri il manuale utente')
        manual_action.triggered.connect(self.show_manual)
        help_menu.addAction(manual_action)
        
        help_menu.addSeparator()
        
        about_action = QAction(QIcon.fromTheme('help-about'), '&Informazioni', self)
        about_action.setStatusTip('Informazioni sul programma')
        about_action.triggered.connect(self.show_about)
        help_menu.addAction(about_action)
        
        about_qt_action = QAction('Informazioni su &Qt', self)
        about_qt_action.setStatusTip('Informazioni su Qt')
        about_qt_action.triggered.connect(QApplication.aboutQt)
        help_menu.addAction(about_qt_action)
        
    def setup_toolbar(self):
        """Configura toolbar"""
        toolbar = self.addToolBar('Principale')
        toolbar.setToolButtonStyle(Qt.ToolButtonTextUnderIcon)
        toolbar.setMovable(False)
        
        # Azioni toolbar
        new_action = QAction(
            self.style().standardIcon(QStyle.SP_FileDialogNewFolder), 
            'Nuovo', self
        )
        new_action.setStatusTip('Crea nuovo progetto')
        new_action.triggered.connect(self.new_project)
        toolbar.addAction(new_action)
        
        open_action = QAction(
            self.style().standardIcon(QStyle.SP_DirOpenIcon),
            'Apri', self
        )
        open_action.setStatusTip('Apri progetto esistente')
        open_action.triggered.connect(self.open_project)
        toolbar.addAction(open_action)
        
        save_action = QAction(
            self.style().standardIcon(QStyle.SP_DialogSaveButton),
            'Salva', self
        )
        save_action.setStatusTip('Salva progetto corrente')
        save_action.triggered.connect(self.save_project)
        toolbar.addAction(save_action)
        
        toolbar.addSeparator()
        
        # Pulsante calcola
        self.calc_action = QAction(
            self.style().standardIcon(QStyle.SP_ComputerIcon),
            'Calcola', self
        )
        self.calc_action.setStatusTip('Esegui calcoli')
        self.calc_action.triggered.connect(self.run_calculation)
        toolbar.addAction(self.calc_action)
        
        # Pulsante relazione (disabilitato per ora)
        self.report_action = QAction(
            self.style().standardIcon(QStyle.SP_FileDialogDetailedView),
            'Relazione', self
        )
        self.report_action.setStatusTip('Genera relazione di calcolo')
        self.report_action.setEnabled(False)  # Sar√† abilitato quando il calcolo √® completato
        toolbar.addAction(self.report_action)
        
        # Spacer per allineare a destra
        spacer = QWidget()
        spacer.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Expanding)
        toolbar.addWidget(spacer)
        
        # Info progetto nella toolbar
        self.project_info_label = QLabel("Nuovo progetto")
        self.project_info_label.setStyleSheet("padding: 0 10px;")
        toolbar.addWidget(self.project_info_label)
        
    def setup_statusbar(self):
        """Configura status bar"""
        self.status_bar = self.statusBar()
        self.status_bar.showMessage("Pronto")
        
        # Widget permanenti nella status bar
        self.coord_label = QLabel("X: 0, Y: 0")
        self.coord_label.setMinimumWidth(100)
        self.status_bar.addPermanentWidget(self.coord_label)
        
        self.zoom_label = QLabel("Zoom: 100%")
        self.zoom_label.setMinimumWidth(80)
        self.status_bar.addPermanentWidget(self.zoom_label)
        
    def on_data_changed(self):
        """Chiamato quando i dati cambiano"""
        self.is_modified = True
        self.update_title()
        
        # Sincronizza dati tra moduli quando cambiano
        if self.tabs.currentIndex() == 0:  # Tab struttura
            self.sync_modules_data()
            
    def on_tab_changed(self, index):
        """Chiamato quando si cambia tab"""
        tab_names = ["Struttura", "Aperture", "Calcolo", "Relazione"]
        if index < len(tab_names):
            self.status_bar.showMessage(f"Modulo attivo: {tab_names[index]}")
            
        # Sincronizza dati quando si passa al modulo aperture
        if index == 1 and hasattr(self, 'input_module') and hasattr(self, 'openings_module'):
            wall_data = self.input_module.collect_data().get('wall')
            if wall_data:
                self.openings_module.set_wall_data(wall_data)
                
            # Sincronizza aperture dal modulo input al modulo aperture
            openings = self.input_module.collect_data().get('openings', [])
            self.openings_module.set_openings(openings)
            
        # Passa dati al modulo calcolo quando si attiva
        elif index == 2 and hasattr(self, 'calc_module'):
            self.update_calc_module_data()
            
    def new_project(self):
        """Crea nuovo progetto"""
        if self.is_modified:
            reply = QMessageBox.question(
                self, 'Nuovo Progetto',
                'Il progetto corrente ha modifiche non salvate.\n'
                'Vuoi salvare prima di creare un nuovo progetto?',
                QMessageBox.Save | QMessageBox.Discard | QMessageBox.Cancel
            )
            
            if reply == QMessageBox.Save:
                if not self.save_project():
                    return
            elif reply == QMessageBox.Cancel:
                return
        
        # Reset tutti i moduli
        if hasattr(self, 'input_module') and self.input_module:
            self.input_module.reset()
        if hasattr(self, 'openings_module') and self.openings_module:
            self.openings_module.reset()
        
        # Reset stato
        self.project_data = {}
        self.current_file = None
        self.is_modified = False
        self.update_title()
        
        self.status_bar.showMessage("Nuovo progetto creato", 3000)
        
    def open_project(self):
        """Apri progetto esistente"""
        if self.is_modified:
            reply = QMessageBox.question(
                self, 'Apri Progetto',
                'Il progetto corrente ha modifiche non salvate.\n'
                'Vuoi salvare prima di aprire un altro progetto?',
                QMessageBox.Save | QMessageBox.Discard | QMessageBox.Cancel
            )
            
            if reply == QMessageBox.Save:
                if not self.save_project():
                    return
            elif reply == QMessageBox.Cancel:
                return
        
        filename, _ = QFileDialog.getOpenFileName(
            self, "Apri Progetto",
            os.path.join(os.path.expanduser("~"), "projects"),
            "File Cerchiature (*.cerch);;JSON (*.json);;Tutti i file (*.*)"
        )
        
        if filename:
            self.load_project_file(filename)
            
    def load_project_file(self, filename):
        """Carica un file progetto"""
        try:
            with open(filename, 'r', encoding='utf-8') as f:
                data = json.load(f)
                
            # Carica i dati nei moduli
            if hasattr(self, 'input_module') and self.input_module:
                self.input_module.load_data(data)
                
            if hasattr(self, 'openings_module') and self.openings_module:
                # Le aperture con rinforzi sono nel modulo aperture
                openings_data = data.get('openings_module', {})
                self.openings_module.load_data(openings_data)
            
            # Aggiorna stato
            self.project_data = data
            self.current_file = filename
            self.is_modified = False
            self.update_title()
            self.add_to_recent(filename)
            
            self.status_bar.showMessage(f"Progetto caricato: {os.path.basename(filename)}", 3000)
            
        except Exception as e:
            QMessageBox.critical(
                self, "Errore",
                f"Errore nel caricamento del file:\n{str(e)}"
            )
            
    def save_project(self):
        """Salva progetto"""
        if not self.current_file:
            return self.save_project_as()
            
        return self.save_project_file(self.current_file)
        
    def save_project_as(self):
        """Salva progetto con nome"""
        filename, _ = QFileDialog.getSaveFileName(
            self, "Salva Progetto",
            os.path.join(os.path.expanduser("~"), "projects", "progetto.cerch"),
            "File Cerchiature (*.cerch);;JSON (*.json)"
        )
        
        if filename:
            # Assicura estensione corretta
            if not filename.endswith(('.cerch', '.json')):
                filename += '.cerch'
                
            return self.save_project_file(filename)
            
        return False
        
    def save_project_file(self, filename):
        """Salva progetto su file"""
        try:
            # Raccogli dati da tutti i moduli
            if hasattr(self, 'input_module') and self.input_module:
                self.project_data = self.input_module.collect_data()
                
            # Aggiungi dati del modulo aperture
            if hasattr(self, 'openings_module') and self.openings_module:
                self.project_data['openings_module'] = self.openings_module.collect_data()
            
            # Salva su file
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(self.project_data, f, indent=2, ensure_ascii=False)
                
            # Aggiorna stato
            self.current_file = filename
            self.is_modified = False
            self.update_title()
            self.add_to_recent(filename)
            
            self.status_bar.showMessage(f"Progetto salvato: {os.path.basename(filename)}", 3000)
            return True
            
        except Exception as e:
            QMessageBox.critical(
                self, "Errore",
                f"Errore nel salvataggio del file:\n{str(e)}"
            )
            return False
            
    def update_title(self):
        """Aggiorna titolo finestra"""
        title = "Calcolatore Cerchiature NTC 2018 - Arch. M. Bartolotta"
        
        if self.current_file:
            title = f"{os.path.basename(self.current_file)} - {title}"
            self.project_info_label.setText(os.path.basename(self.current_file))
        else:
            self.project_info_label.setText("Nuovo progetto")
            
        if self.is_modified:
            title = f"*{title}"
            
        self.setWindowTitle(title)
        
    def add_to_recent(self, filename):
        """Aggiunge file ai recenti"""
        settings = QSettings("ArchBartolotta", "CerchiatureNTC2018")
        recent = settings.value("recentFiles", [])
        
        if isinstance(recent, str):
            recent = [recent] if recent else []
            
        # Rimuovi se gi√† presente
        if filename in recent:
            recent.remove(filename)
            
        # Aggiungi in cima
        recent.insert(0, filename)
        
        # Mantieni solo gli ultimi 10
        recent = recent[:10]
        
        settings.setValue("recentFiles", recent)
        self.update_recent_menu()
        
    def update_recent_menu(self):
        """Aggiorna menu progetti recenti"""
        self.recent_menu.clear()
        
        settings = QSettings("ArchBartolotta", "CerchiatureNTC2018")
        recent = settings.value("recentFiles", [])
        
        if isinstance(recent, str):
            recent = [recent] if recent else []
            
        for i, filename in enumerate(recent):
            if os.path.exists(filename):
                action = QAction(f"{i+1}. {os.path.basename(filename)}", self)
                action.setData(filename)
                action.triggered.connect(lambda checked, f=filename: self.load_project_file(f))
                self.recent_menu.addAction(action)
                
        if not self.recent_menu.isEmpty():
            self.recent_menu.addSeparator()
            clear_action = QAction("Cancella lista", self)
            clear_action.triggered.connect(self.clear_recent)
            self.recent_menu.addAction(clear_action)
            
    def clear_recent(self):
        """Cancella lista progetti recenti"""
        settings = QSettings("ArchBartolotta", "CerchiatureNTC2018")
        settings.setValue("recentFiles", [])
        self.update_recent_menu()
        
    def show_materials_dialog(self):
        """Mostra dialog database materiali"""
        QMessageBox.information(
            self, "Database Materiali",
            "Il database materiali sar√† disponibile nella prossima versione.\n\n"
            "Conterr√†:\n"
            "‚Ä¢ Tipologie di muratura\n"
            "‚Ä¢ Parametri meccanici\n"
            "‚Ä¢ Valori da normativa"
        )
        
    def show_profiles_dialog(self):
        """Mostra dialog database profili"""
        QMessageBox.information(
            self, "Database Profili",
            "Il database profili sar√† disponibile nella prossima versione.\n\n"
            "Conterr√†:\n"
            "‚Ä¢ Profili HEA, HEB, IPE\n"
            "‚Ä¢ Profili UNP, L\n"
            "‚Ä¢ Tubolari\n"
            "‚Ä¢ Caratteristiche geometriche"
        )
        
    def show_settings_dialog(self):
        """Mostra dialog impostazioni"""
        QMessageBox.information(
            self, "Impostazioni",
            "Le impostazioni saranno disponibili nella prossima versione.\n\n"
            "Sar√† possibile configurare:\n"
            "‚Ä¢ Dati professionista\n"
            "‚Ä¢ Percorsi predefiniti\n"
            "‚Ä¢ Unit√† di misura\n"
            "‚Ä¢ Opzioni di calcolo"
        )
        
    def show_manual(self):
        """Mostra manuale utente"""
        QMessageBox.information(
            self, "Manuale Utente",
            "Il manuale utente √® in preparazione.\n\n"
            "Per assistenza:\n"
            "Arch. Michelangelo Bartolotta\n"
            "architettomichelangelo@gmail.com"
        )
        
    def show_about(self):
        """Mostra dialog informazioni"""
        about_text = """
        <h2>Calcolatore Cerchiature NTC 2018</h2>
        <p><b>Versione 1.0.0</b></p>
        
        <p>Software professionale per la verifica di interventi locali<br>
        su murature portanti secondo NTC 2018 ¬ß 8.4.1</p>
        
        <p><b>Sviluppato da:</b><br>
        Arch. Michelangelo Bartolotta<br>
        Ordine degli Architetti di Agrigento n. 1557</p>
        
        <p><b>Contatti:</b><br>
        Via Domenico Scin√† n. 28, Palermo<br>
        architettomichelangelo@gmail.com</p>
        
        <p><b>Tecnologie utilizzate:</b><br>
        Python 3, PyQt5, NumPy, Matplotlib</p>
        
        <hr>
        <p><small>Copyright ¬© 2024 - Tutti i diritti riservati</small></p>
        """
        
        msg_box = QMessageBox(self)
        msg_box.setWindowTitle("Informazioni")
        msg_box.setTextFormat(Qt.RichText)
        msg_box.setText(about_text)
        msg_box.setStandardButtons(QMessageBox.Ok)
        
        # Aggiungi icona se disponibile
        # msg_box.setIconPixmap(QPixmap("resources/icons/logo.png").scaled(64, 64, Qt.KeepAspectRatio, Qt.SmoothTransformation))
        
        msg_box.exec_()
        
    def closeEvent(self, event):
        """Gestisce chiusura applicazione"""
        if self.is_modified:
            reply = QMessageBox.question(
                self, 'Esci',
                'Il progetto corrente ha modifiche non salvate.\n'
                'Vuoi salvare prima di uscire?',
                QMessageBox.Save | QMessageBox.Discard | QMessageBox.Cancel
            )
            
            if reply == QMessageBox.Save:
                if self.save_project():
                    event.accept()
            
    def update_calc_module_data(self):
        """Aggiorna i dati nel modulo calcolo"""
        if not hasattr(self, 'calc_module'):
            return
            
        # Raccogli tutti i dati dai moduli
        project_data = {}
        
        if hasattr(self, 'input_module'):
            input_data = self.input_module.collect_data()
            project_data.update(input_data)
            
        if hasattr(self, 'openings_module'):
            openings_data = self.openings_module.collect_data()
            project_data['openings_module'] = openings_data
            
        # Passa i dati al modulo calcolo
        self.calc_module.set_project_data(project_data)
        
    def run_calculation(self):
        """Avvia il calcolo dal toolbar"""
        # Vai al tab calcolo
        self.tabs.setCurrentIndex(2)
        
        # Aggiorna dati e avvia calcolo
        if hasattr(self, 'calc_module'):
            self.update_calc_module_data()
            self.calc_module.run_calculation()
            
    def on_calculation_done(self, results):
        """Chiamato quando il calcolo √® completato"""
        self.status_bar.showMessage("Calcolo completato", 3000)
        
        # Abilita il pulsante per generare la relazione se il modulo √® disponibile
        if hasattr(self, 'report_action'):
            self.report_action.setEnabled(True)
                else:
                    event.ignore()
            elif reply == QMessageBox.Discard:
                event.accept()
            else:
                event.ignore()
        else:
            event.accept()